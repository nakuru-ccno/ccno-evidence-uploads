<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  /* your existing styles here */
</style>
</head>
<body>

<header>
  <img src="NAKURU LOGO.png" alt="Logo">
  Nakuru County CCNO PC Evidence Upload
</header>

<div class="container">
  <!-- your existing form fields here -->
  <label>Evidence Name:</label>
  <input type="text" id="evidenceName" placeholder="e.g., CME on Family Planning Methods">

  <label>Evidence Category:</label>
  <select id="category">
    <option value="">Select Evidence Category</option>
    <option>C02 Referral System Improved</option>
    <option>C04 Operationalization of Health Facilities to Better Services</option>
    <option>C10 Theater Services Improved</option>
    <option>C11 In-Patient Services Improved</option>
    <option>C14 ANC (Antenatal Care)</option>
    <option>C15 POSTNATAL CARE</option>
    <option>C16 MPDSR (Maternal and Perinatal Death Surveillance and Response)</option>
    <option>C17 FAMILY PLANNING</option>
    <option>C18 IMMUNIZATION</option>
    <option>C21 HIV SERVICES</option>
    <option>C23 BURDEN OF CANCER REDUCED</option>
    <option>C27 SUPPORT SUPERVISION</option>
  </select>

  <label>Sub County:</label>
  <select id="subCounty">
    <option value="">Select Sub County</option>
    <option>Nakuru West Sub County</option>
    <option>Nakuru East Sub County</option>
    <option>Nakuru North Sub County</option>
    <option>Naivasha Sub County</option>
    <option>Rongai Sub County</option>
    <option>Kuresoi South Sub County</option>
    <option>Kuresoi North Sub County</option>
    <option>Subukia Sub County</option>
    <option>Molo Sub County</option>
    <option>Njoro Sub County</option>
    <option>Gilgil Sub County</option>
  </select>

  <label>Choose PDF file(s) (max 3MB each, up to 5 files):</label>
  <input type="file" id="files" accept="application/pdf" multiple>

  <div class="spinner" id="spinner">⏳ Uploading...</div>
  <div class="success" id="success">✅ Upload successful!</div>
  <div class="error" id="error"></div>

  <button onclick="upload()">Upload</button>
  <button type="button" onclick="resetForm()">Reset</button>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGwRMVtQyksOJBUeeaA6zhUvhSd5reOTdivoS8FSwvL_d-j4Iyj4zZDQrmY88EkfEpzQ/exec";

function upload() {
  const evidenceName = document.getElementById('evidenceName').value.trim();
  const category = document.getElementById('category').value;
  const subCounty = document.getElementById('subCounty').value;
  const files = document.getElementById('files').files;

  clearMessages();

  if (!evidenceName || !category || !subCounty || files.length === 0) {
    showError('Please fill in all fields and select at least one file.');
    return;
  }
  if (files.length > 5) {
    showError('You can upload a maximum of 5 files.');
    return;
  }

  let fileData = [];
  let promises = [];

  for (let file of files) {
    if (file.size > 3 * 1024 * 1024) {
      showError(`File ${file.name} exceeds 3MB limit.`);
      return;
    }
    promises.push(new Promise((resolve) => {
      let reader = new FileReader();
      reader.onload = function(e) {
        let content = e.target.result.split(',')[1];
        fileData.push({ name: file.name, type: file.type, data: content });
        resolve();
      };
      reader.readAsDataURL(file);
    }));
  }

  Promise.all(promises).then(() => {
    document.getElementById('spinner').style.display = 'block';

    fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ evidenceName, category, subCounty, files: fileData }),
    })
    .then(response => response.text()) // response is HTML with JSON string
    .then(text => {
      // The Apps Script returns JSON string wrapped as HTML text
      let data;
      try {
        data = JSON.parse(text);
      } catch (err) {
        showError("Failed to parse response from server.");
        document.getElementById('spinner').style.display = 'none';
        return;
      }
      document.getElementById('spinner').style.display = 'none';
      if (data.status === "success") {
        document.getElementById('success').style.display = 'block';
      } else {
        showError(data.message || "Upload failed.");
      }
    })
    .catch(err => {
      document.getElementById('spinner').style.display = 'none';
      showError("Upload failed: " + err.message);
    });
  });
}

function showError(msg) {
  const errDiv = document.getElementById('error');
  errDiv.innerText = msg;
  errDiv.style.display = 'block';
}

function clearMessages() {
  document.getElementById('error').style.display = 'none';
  document.getElementById('success').style.display = 'none';
}

function resetForm() {
  document.getElementById('evidenceName').value = '';
  document.getElementById('category').value = '';
  document.getElementById('subCounty').value = '';
  document.getElementById('files').value = '';
  clearMessages();
  document.getElementById('spinner').style.display = 'none';
}
</script>

</body>
</html>
